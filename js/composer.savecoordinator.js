!function(global,$,_){"use strict";function SaveCoordinator($form,options){this.init.apply(this,_.toArray(arguments))}SaveCoordinator.prototype={init:function($form,saver,options){var defaultOptions={saveValidator:function(saver){return saver.canSave()},debug:!0,idleTimeout:20,saveThrottleEnabled:!0,saveThrottleTimeout:10,saveDebounceEnabled:!0,saveDebounceTimeout:2,saveDebounceMaximum:11};this.lastSerialized=null,this.saveThrottleTimer=null,this.saveDebounceTimer=null,this.saveDebounceBegan=null,this.idleTimer=null,this.enabled=!1,this.queuedSave=!1,this.options=defaultOptions,this.options=_(defaultOptions).extend(options),this.options.form=$form,this.options.saver=saver,this.saving=!1,this.status={idle:0,saving:1,busy:2,throttled:3,debounced:4,saveFailed:5,disabled:6},this.cachedForm(this.getFormSerialized())},isEnabled:function(){return this.enabled},enable:function(){this.resetIdleTimer(),this.enabled=!0},disable:function(){this.enabled=!1,this.disableIdleTimer()},disableIdleTimer:function(){global.clearTimeout(this.idleTimer),this.idleTimer=null},requestSave:function(queue){return this.resetIdleTimer(),this.enabled?"undefined"!=typeof queue&&queue?this.requestQueuedSave():this.saving?(this.queuedSave=!0,this.status.busy):this.options.saveValidator(this)?this.options.saveThrottleEnabled&&this.throttleSave()?(this.resetThrottle(),this.status.throttled):this.options.saveDebounceEnabled?this.debounceSave():(this.debug("Handling Save Synchronous"),this.handleSave()):(this.debug("Save Not Needed"),this.status.saveFailed):this.status.disabled},requestQueuedSave:function(){var result=this.requestSave();return result===this.status.throttled&&(this.debug("Queuing Save"),this.queuedSave=!0),result},handleSave:function(){if(!this.enabled)return this.status.disabled;if(this.saving)return this.status.busy;this.saving=!0;var my=this,formData=this.cachedForm(this.getFormSerialized()),saveHandler=function(){my.saving=!1,my.resetThrottle(),my.resetIdleTimer()};return this.options.saver(this,formData,saveHandler)?this.status.saving:this.status.saveFailed},resetIdleTimer:function(){var me=this;this.idleTimer&&global.clearTimeout(this.idleTimer),this.idleTimer=setTimeout(function(){me.requestSave(),me.resetIdleTimer()},1e3*this.options.idleTimeout)},canSave:function(){return!this.cachedFormEquals(this.getFormSerialized())},debounceSave:function(){if(!this.enabled)return this.status.disabled;this.saveDebounceTimer&&global.clearTimeout(this.saveDebounceTimer),this.saveDebounceBegan||(this.saveDebounceBegan=_.now());var timePassed=_.now()-this.saveDebounceBegan,timeLeft=1e3*this.options.saveDebounceMaximum-timePassed,timeout=Math.max(0,Math.min(1e3*this.options.saveDebounceTimeout,timeLeft)),me=this;return this.options.saveDebounceMaximum||(timeout=this.options.saveDebounceTimeout),this.saveDebounceTimer=global.setTimeout(function(){me.debug("Debouncing Expired, Handling Save"),me.saveDebounceBegan=null,me.handleSave()},timeout),this.debug("Debouncing Save for "+timeout+"ms"),this.status.debounced},resetThrottle:function(){this.throttleSave(1e3*this.options.saveThrottleTimeout)},throttleSave:function(amount){var me=this,throttled=null!=this.saveThrottleTimer;return null==this.saveThrottleTimer&&"undefined"!=typeof amount&&(this.saveThrottleTimer=global.setTimeout(function(){me.debug("Throttle Expired"),me.saveThrottleTimer=null,me.queuedSave&&(me.debug("Handling Queued Save"),me.handleSave(),me.queuedSave=!1)},amount),this.debug("Throttling Save")),throttled},getForm:function(){return this.options.form},getFormSerialized:function(){return this.getForm().serializeArray()},cachedForm:function(serialized){return"undefined"!=typeof serialized&&(this.lastSerialized=serialized),this.lastSerialized},cachedFormEquals:function(value){return _(this.cachedForm()).isEqual(value)},debug:function(message){this.options.debug&&global.console.log("SaverCoordinator: "+message)}},global.Concrete||(global.Concrete={}),global.Concrete.composer||(global.Concrete.composer={}),global.Concrete.composer.SaveCoodinator=SaveCoordinator,$.fn.saveCoordinator=function(saver,options){return this.each(function(){var me=$(this),coordinator=new SaveCoordinator(me,saver,options);me.data("SaveCoordinator",coordinator)})}}(this,jQuery,_);
//# sourceMappingURL=/concrete/js/composer.savecoordinator.js.map